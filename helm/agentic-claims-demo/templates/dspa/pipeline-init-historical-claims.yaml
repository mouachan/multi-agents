{{- if .Values.tekton.enabled }}
---
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: init-historical-claims
  namespace: {{ include "agentic-claims-demo.namespace" . }}
  labels:
    {{- include "agentic-claims-demo.labels" . | nindent 4 }}
    app.kubernetes.io/component: tekton-pipeline
spec:
  description: >
    Initialize historical claims data pipeline.

    This pipeline demonstrates RHOAI Data Science Pipelines capabilities:
    1. Generate realistic PDFs from seed data (Data Engineering)
    2. Parse PDFs with Docling (Advanced Document Processing)
    3. Generate embeddings with LlamaStack (ML Feature Engineering)

    Used for: One-time initialization of historical claims for RAG similarity search.
    Complements: Real-time claim processing via MCP Servers (OCR, RAG).

  params:
    - name: batch-size
      type: string
      description: Number of documents to process per batch
      default: "5"
    - name: skip-pdf-generation
      type: string
      description: Skip PDF generation step (use existing PDFs)
      default: "false"

  workspaces:
    - name: pdfs-workspace
      description: Shared workspace for PDF files

  tasks:
    # Task 1: Generate PDFs from seed data
    - name: generate-pdfs
      when:
        - input: $(params.skip-pdf-generation)
          operator: in
          values: ["false", "False", "FALSE"]
      taskRef:
        name: generate-realistic-pdfs
      workspaces:
        - name: pdfs
          workspace: pdfs-workspace
      params:
        - name: output-path
          value: /workspace/pdfs

    # Task 2: Parse PDFs with Docling
    - name: docling-parse
      runAfter:
        - generate-pdfs
      taskRef:
        name: docling-parse-pdfs
      workspaces:
        - name: pdfs
          workspace: pdfs-workspace
      params:
        - name: pdf-path
          value: /workspace/pdfs

    # Task 3: Generate embeddings
    - name: generate-embeddings
      runAfter:
        - docling-parse
      taskRef:
        name: generate-embeddings
      params:
        - name: batch-size
          value: $(params.batch-size)
        - name: max-retries
          value: "30"

  finally:
    # Cleanup task (optional)
    - name: cleanup
      params:
        - name: aggregate-status
          value: $(tasks.status)
      taskSpec:
        params:
          - name: aggregate-status
        steps:
          - name: log-status
            image: registry.access.redhat.com/ubi9/ubi-minimal:latest
            script: |
              #!/bin/sh
              echo "============================================"
              echo "Pipeline Status: $(params.aggregate-status)"
              echo "============================================"
              if [ "$(params.aggregate-status)" = "Succeeded" ]; then
                echo "✅ All historical claims initialized successfully!"
                echo "   - PDFs generated and parsed with Docling"
                echo "   - Embeddings created for RAG similarity search"
                echo "   - Ready for real-time claim processing"
              else
                echo "❌ Pipeline failed. Check task logs above."
              fi
              echo "============================================"
{{- end }}
