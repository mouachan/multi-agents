{{- if .Values.tekton.enabled }}
---
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: generate-realistic-pdfs
  namespace: {{ include "agentic-claims-demo.namespace" . }}
  labels:
    {{- include "agentic-claims-demo.labels" . | nindent 4 }}
    app.kubernetes.io/component: tekton-task
spec:
  description: >
    Generate realistic PDFs from seed data OCR texts.
    Reads claim_documents from PostgreSQL and creates PDF files.

  params:
    - name: output-path
      type: string
      description: Path where PDFs will be stored
      default: /workspace/pdfs

  workspaces:
    - name: pdfs
      description: Workspace to store generated PDFs
      mountPath: /workspace/pdfs

  steps:
    - name: install-dependencies
      image: registry.access.redhat.com/ubi9/python-312:latest
      script: |
        #!/bin/bash
        set -e
        echo "Installing Python dependencies..."
        pip install --no-cache-dir \
          reportlab==4.2.5 \
          sqlalchemy==2.0.36 \
          psycopg2-binary==2.9.10
        echo "✓ Dependencies installed"

    - name: generate-pdfs
      image: registry.access.redhat.com/ubi9/python-312:latest
      env:
        - name: POSTGRES_HOST
          value: {{ .Values.postgresql.service.name | default "postgresql" }}.{{ include "agentic-claims-demo.namespace" . }}.svc.cluster.local
        - name: POSTGRES_PORT
          value: "5432"
        - name: POSTGRES_DATABASE
          valueFrom:
            secretKeyRef:
              name: {{ .Values.postgresql.auth.existingSecret }}
              key: {{ .Values.postgresql.auth.secretKeys.databaseKey }}
        - name: POSTGRES_USER
          valueFrom:
            secretKeyRef:
              name: {{ .Values.postgresql.auth.existingSecret }}
              key: {{ .Values.postgresql.auth.secretKeys.userNameKey }}
        - name: POSTGRES_PASSWORD
          valueFrom:
            secretKeyRef:
              name: {{ .Values.postgresql.auth.existingSecret }}
              key: {{ .Values.postgresql.auth.secretKeys.userPasswordKey }}
        - name: OUTPUT_DIR
          value: $(params.output-path)
      script: |
        #!/usr/bin/env python3
        """Generate realistic PDFs from seed data OCR texts."""

        import logging
        import os
        import sys
        from datetime import datetime
        from pathlib import Path

        from reportlab.lib.pagesizes import letter
        from reportlab.lib.styles import getSampleStyleSheet, ParagraphStyle
        from reportlab.lib.units import inch
        from reportlab.platypus import SimpleDocTemplate, Paragraph, Spacer, Table, TableStyle
        from reportlab.lib import colors
        from sqlalchemy import create_engine, text
        from sqlalchemy.orm import sessionmaker

        logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')
        logger = logging.getLogger(__name__)

        # Database connection
        DATABASE_URL = f"postgresql://{os.getenv('POSTGRES_USER')}:{os.getenv('POSTGRES_PASSWORD')}@{os.getenv('POSTGRES_HOST')}:{os.getenv('POSTGRES_PORT')}/{os.getenv('POSTGRES_DATABASE')}"
        OUTPUT_DIR = os.getenv('OUTPUT_DIR', '/workspace/pdfs')

        def create_pdf(output_path, claim_number, claim_type, ocr_text):
            """Create PDF from OCR text."""
            doc = SimpleDocTemplate(output_path, pagesize=letter,
                                   rightMargin=0.75*inch, leftMargin=0.75*inch,
                                   topMargin=0.75*inch, bottomMargin=0.75*inch)
            elements = []
            styles = getSampleStyleSheet()

            # Title
            title_style = ParagraphStyle('Title', parent=styles['Heading1'],
                                        fontSize=16, alignment=1, spaceAfter=12)
            elements.append(Paragraph("INSURANCE CLAIM DOCUMENT", title_style))
            elements.append(Spacer(1, 0.2*inch))

            # Claim info
            claim_data = [['Claim Number:', claim_number],
                         ['Claim Type:', claim_type],
                         ['Date:', datetime.now().strftime('%Y-%m-%d')]]
            claim_table = Table(claim_data, colWidths=[2*inch, 4*inch])
            claim_table.setStyle(TableStyle([
                ('BACKGROUND', (0,0), (0,-1), colors.lightgrey),
                ('GRID', (0,0), (-1,-1), 0.5, colors.grey),
                ('FONTNAME', (0,0), (0,-1), 'Helvetica-Bold'),
                ('PADDING', (0,0), (-1,-1), 6)
            ]))
            elements.append(claim_table)
            elements.append(Spacer(1, 0.3*inch))

            # Content
            for line in ocr_text.split('\n'):
                if line.strip():
                    escaped = line.replace('&','&amp;').replace('<','&lt;').replace('>','&gt;')
                    elements.append(Paragraph(escaped, styles['Normal']))
                else:
                    elements.append(Spacer(1, 0.1*inch))

            doc.build(elements)

        def main():
            logger.info(f"Generating PDFs to {OUTPUT_DIR}")
            Path(OUTPUT_DIR).mkdir(parents=True, exist_ok=True)

            engine = create_engine(DATABASE_URL, pool_pre_ping=True)
            SessionLocal = sessionmaker(bind=engine)

            with SessionLocal() as session:
                query = text("""
                    SELECT c.claim_number, c.claim_type, cd.raw_ocr_text, cd.file_path
                    FROM claim_documents cd
                    JOIN claims c ON cd.claim_id = c.id
                    WHERE cd.raw_ocr_text IS NOT NULL
                    ORDER BY c.claim_number
                """)
                documents = session.execute(query).fetchall()

            logger.info(f"Found {len(documents)} documents to generate")
            generated = 0

            for row in documents:
                filename = Path(row.file_path).name
                pdf_path = Path(OUTPUT_DIR) / filename
                try:
                    create_pdf(str(pdf_path), row.claim_number, row.claim_type, row.raw_ocr_text)
                    generated += 1
                    if generated % 10 == 0:
                        logger.info(f"Progress: {generated}/{len(documents)}")
                except Exception as e:
                    logger.error(f"Failed {row.claim_number}: {e}")

            logger.info(f"✅ Generated {generated}/{len(documents)} PDFs")
            engine.dispose()

        if __name__ == "__main__":
            main()
      resources:
        requests:
          cpu: 500m
          memory: 1Gi
        limits:
          cpu: 1000m
          memory: 2Gi
{{- end }}
