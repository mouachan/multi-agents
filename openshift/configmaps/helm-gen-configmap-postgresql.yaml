apiVersion: v1
kind: ConfigMap
metadata:
  annotations:
    argocd.argoproj.io/sync-wave: '1'
  name: postgresql
  namespace: claims-demo
  labels:
    helm.sh/chart: agentic-claims-demo-1.0.0
    app.kubernetes.io/name: agentic-claims-demo
    app.kubernetes.io/instance: agentic-claims-demo
    app.kubernetes.io/version: 1.0.0
    app.kubernetes.io/managed-by: Helm
    app: postgresql
data:
  init.sh: "#!/bin/sh\n\n# read values from Secret\nPOSTGRESQL_ADMIN_PASSWORD=\"$(cat\
    \ /cluster-secrets/POSTGRES_ADMIN_PASSWORD)\"\nPOSTGRESQL_DATABASE=\"$(cat /cluster-secrets/POSTGRES_DATABASE)\"\
    \nPOSTGRESQL_PASSWORD=\"$(cat /cluster-secrets/POSTGRES_PASSWORD)\"\nPOSTGRESQL_USER=\"\
    $(cat /cluster-secrets/POSTGRES_USER)\"\n\n# write custom entrypoint for postgres\n\
    cat <<EOF >/runtime-secrets/database/entrypoint.sh\n#!/bin/sh\n# Support both\
    \ Red Hat and standard PostgreSQL images\nexport POSTGRES_PASSWORD=\"$POSTGRESQL_PASSWORD\"\
    \nexport POSTGRES_USER=\"$POSTGRESQL_USER\"\nexport POSTGRES_DB=\"$POSTGRESQL_DATABASE\"\
    \nexport POSTGRESQL_ADMIN_PASSWORD=\"$POSTGRESQL_ADMIN_PASSWORD\"\nexport POSTGRESQL_DATABASE=\"\
    $POSTGRESQL_DATABASE\"\nexport POSTGRESQL_PASSWORD=\"$POSTGRESQL_PASSWORD\"\n\
    export POSTGRESQL_USER=\"$POSTGRESQL_USER\"\necho done exporting vars\n\n# Use\
    \ Red Hat entrypoint if available, otherwise use standard docker-entrypoint\n\
    if [ -f /usr/bin/run-postgresql ]; then\n  exec /usr/bin/run-postgresql\nelse\n\
    \  exec docker-entrypoint.sh postgres\nfi\nEOF\nchmod +x /runtime-secrets/database/entrypoint.sh\n\
    echo done generating entrypoint for postgresql\n\n# write custom readiness probe\
    \ for postgresql\ncat <<EOF >/runtime-secrets/database/ready.sh\n#!/bin/sh\nPOSTGRESQL_DATABASE=\"\
    $POSTGRESQL_DATABASE\"\nPOSTGRESQL_PASSWORD=\"$POSTGRESQL_PASSWORD\"\nPOSTGRESQL_USER=\"\
    $POSTGRESQL_USER\"\nexport POSTGRESQL_DATABASE\nexport POSTGRESQL_PASSWORD\nexport\
    \ POSTGRESQL_USER\n\n# Use Red Hat check-container if available, otherwise use\
    \ pg_isready\nif [ -f /usr/libexec/check-container ]; then\n  exec /usr/libexec/check-container\n\
    else\n  exec pg_isready -U \"\\$POSTGRESQL_USER\" -d \"\\$POSTGRESQL_DATABASE\"\
    \nfi\nEOF\nchmod +x /runtime-secrets/database/ready.sh\necho done generating readiness\
    \ probe for postgres\n"
